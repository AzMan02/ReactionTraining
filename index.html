<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>나침반 반응 훈련 Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2d3436">
    <style>
        :root { --bg-color: #2d3436; --needle-main: #ffffff; --needle-sub: #1e272e; --accent: #fbc531; }
        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: #dfe6e9;
            transition: background-color 0.4s ease-in-out; font-family: system-ui, sans-serif;
            width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center;
            overflow: hidden; touch-action: none;
        }
        #compass-container {
            position: relative; width: min(92vw, 92vh); height: min(92vw, 92vh);
            border: 5px solid rgba(255,255,255,0.25); border-radius: 50%;
            background: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        #total-timer {
            position: absolute; font-size: min(55vw, 55vh); font-weight: 900;
            color: rgba(255, 255, 255, 0.12); -webkit-text-stroke: 1px rgba(255, 255, 255, 0.05);
            filter: drop-shadow(0 0 15px rgba(0,0,0,0.2)); z-index: 0; pointer-events: none;
            letter-spacing: -5px; line-height: 1; font-variant-numeric: tabular-nums;
        }
        #inner-info {
            position: absolute; bottom: 12%; width: 85%; text-align: center; z-index: 1; 
            pointer-events: none; transition: opacity 0.3s ease;
        }
        #status-msg { 
            font-size: clamp(1.2rem, 6vw, 2.2rem); font-weight: 900; margin-bottom: 5px; 
            color: #ffffff; text-shadow: 2px 2px 10px rgba(0,0,0,0.9);
        }
        #setting-display { 
            font-size: clamp(0.9rem, 4vw, 1.5rem); color: #ffffff; 
            font-weight: bold; letter-spacing: 1px; text-shadow: 1px 1px 5px rgba(0,0,0,0.9);
        }
        .val { color: var(--accent); }
        .tick { position: absolute; width: 4px; height: 22px; background: rgba(255,255,255,0.6); }
        #needle-wrapper {
            position: absolute; width: 100%; height: 100%;
            transition: transform 0.45s cubic-bezier(0.4, 0, 0.2, 1.2);
            display: flex; align-items: center; justify-content: center; z-index: 5;
        }
        #needle-main {
            position: relative; width: min(12vw, 10vh); height: 75%;
            display: flex; align-items: center; justify-content: center;
            filter: drop-shadow(0 0 8px rgba(0,0,0,1));
        }
        #needle-main::before {
            content: ''; position: absolute; bottom: 50%;
            border-left: min(6vw, 5vh) solid transparent; border-right: min(6vw, 5vh) solid transparent;
            border-bottom: min(35vw, 35vh) solid var(--needle-main);
        }
        #needle-main::after {
            content: ''; position: absolute; top: 50%;
            border-left: min(6vw, 5vh) solid transparent; border-right: min(6vw, 5vh) solid transparent;
            border-top: min(12vw, 12vh) solid var(--needle-sub);
        }
    </style>
</head>
<body>

    <div id="compass-container">
        <div id="total-timer">0</div>
        <div id="inner-info">
            <div id="status-msg">터치하여 시작</div>
            <div id="setting-display">인터벌: <span id="current-val" class="val">5</span>&plusmn;2</div>
        </div>
        <div id="needle-wrapper"><div id="needle-main"></div></div>
    </div>

    <script>
        const compassContainer = document.getElementById('compass-container');
        const needleWrapper = document.getElementById('needle-wrapper');
        const currentValDisplay = document.getElementById('current-val');
        const statusMsg = document.getElementById('status-msg');
        const innerInfo = document.getElementById('inner-info');
        const totalTimerDisplay = document.getElementById('total-timer');
        
        let isRunning = false;
        let isInitial = true;
        let isWaitingVoice = false;
        let avgInterval = 5;
        let timer = null;
        let totalSeconds = 0;
        let exerciseTimer = null;

        const safeColors = ['#0984e3', '#6c5ce7', '#00cec9', '#ffe119', '#e84393', '#2d3436', '#fdcb6e', '#000080', '#8e44ad', '#2980b9', '#f39c12', '#7f8c8d'];

        window.addEventListener('load', () => {
            const saved = localStorage.getItem('reactionInterval');
            if (saved) {
                avgInterval = parseInt(saved);
                currentValDisplay.textContent = avgInterval;
            }
        });

        const size = Math.min(window.innerWidth * 0.92, window.innerHeight * 0.92);
        for (let i = 0; i < 12; i++) {
            const tick = document.createElement('div');
            tick.className = 'tick';
            tick.style.transform = `rotate(${i * 30}deg) translateY(-${size / 2 - 15}px)`;
            compassContainer.appendChild(tick);
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition ? new SpeechRecognition() : null;
        if(recognition) recognition.lang = 'ko-KR';

        recognition.onresult = (event) => {
            const cmd = event.results[event.results.length - 1].transcript;
            const num = parseInt(cmd.replace(/[^0-9]/g, ""));
            if (num >= 3) {
                avgInterval = num;
                currentValDisplay.textContent = avgInterval;
                localStorage.setItem('reactionInterval', avgInterval);
                
                // 음성 피드백: "n초입니다"만 출력
                speak(`${avgInterval}초입니다.`);
                
                isWaitingVoice = false;
                statusMsg.textContent = "설정 완료!";
                setTimeout(() => { if(!isRunning) statusMsg.textContent = "터치하여 시작"; }, 1500);
            }
        };

        function speak(t) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'ko-KR'; u.rate = 1.4;
            window.speechSynthesis.speak(u);
        }

        function updateExerciseTimer() {
            totalSeconds++;
            totalTimerDisplay.textContent = totalSeconds;
        }

        function runTraining() {
            if (!isRunning) return;
            const visualHour = Math.floor(Math.random() * 12) + 1;
            const audioHour = Math.floor(Math.random() * 12) + 1;
            const randomColor = safeColors[Math.floor(Math.random() * safeColors.length)];
            document.body.style.backgroundColor = randomColor;
            needleWrapper.style.transform = `rotate(${visualHour * 30}deg)`;
            speak(`${audioHour}시`);
            if ("vibrate" in navigator) navigator.vibrate(80);
            const nextTime = Math.floor(Math.random() * 4001) + (avgInterval - 2) * 1000;
            timer = setTimeout(runTraining, Math.max(1200, nextTime));
        }

        compassContainer.addEventListener('click', () => {
            if (isInitial) {
                speak("시간을 입력하세요.");
                if(recognition) try { recognition.start(); } catch(e){}
                isInitial = false; isWaitingVoice = true;
                statusMsg.textContent = "시간 입력";
            } else if (isWaitingVoice) {
                if(recognition) try { recognition.abort(); } catch(e){}
                isWaitingVoice = false;
                startTraining();
            } else {
                if (isRunning) stopTraining();
                else startTraining();
            }
        });

        function startTraining() {
            isRunning = true;
            totalSeconds = 0;
            totalTimerDisplay.textContent = "0";
            innerInfo.style.opacity = "0";
            exerciseTimer = setInterval(updateExerciseTimer, 1000);
            runTraining();
        }

        function stopTraining() {
            isRunning = false;
            clearInterval(exerciseTimer);
            clearTimeout(timer);
            innerInfo.style.opacity = "1";
            document.body.style.backgroundColor = '#2d3436';
            needleWrapper.style.transform = 'rotate(0deg)';
            statusMsg.textContent = "정지됨";
            window.speechSynthesis.cancel();
            setTimeout(() => { if(!isRunning) statusMsg.textContent = "터치하여 시작"; }, 1500);
        }
    </script>
</body>
</html>
