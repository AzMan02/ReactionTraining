<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë°˜ì‘ í›ˆë ¨ Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#222222">
    <style>
        :root { --bg-color: #222; }
        body {
            margin: 0; padding: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 100vh; width: 100vw;
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color); color: white;
            transition: background-color 0.15s ease-out; touch-action: none; overflow: hidden;
        }
        #info { 
            position: absolute; top: env(safe-area-inset-top, 20px); 
            text-align: center; z-index: 10; width: 85%;
            font-size: clamp(0.85rem, 4vw, 1.1rem);
            background: rgba(0,0,0,0.5); padding: 12px; border-radius: 16px;
            backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        #mic-status { color: #ff4757; font-weight: bold; display: block; margin-bottom: 4px; }
        #direction-container { display: flex; align-items: center; justify-content: center; width: 100%; height: 60%; }
        #direction-text { font-size: clamp(5rem, 50vw, 35vh); font-weight: 900; user-select: none; line-height: 1; }
        .val { color: #fbc531; font-weight: bold; }
        @media (orientation: landscape) {
            #info { top: auto; bottom: 5%; left: 50%; transform: translateX(-50%); width: auto; padding: 8px 30px; display: flex; gap: 15px; }
            #direction-text { font-size: 45vh; }
        }
    </style>
</head>
<body>

    <div id="info">
        <span id="mic-status">ğŸ”´ í™”ë©´ì„ í„°ì¹˜í•˜ì„¸ìš”</span>
        <div>ë§ì”€í•˜ì„¸ìš”: <span class="val">"ì‹œì‘", "ì •ì§€", "5ì´ˆ"</span></div>
        <div>ì„¤ì •: <span id="current-val" class="val">5</span>ì´ˆ (<span id="range-val" class="val">3~7</span>ì´ˆ)</div>
    </div>

    <div id="direction-container"><div id="direction-text">READY</div></div>

    <script>
        const directionDisplay = document.getElementById('direction-text');
        const currentValDisplay = document.getElementById('current-val');
        const rangeValDisplay = document.getElementById('range-val');
        const micStatus = document.getElementById('mic-status');
        
        let isRunning = false;
        let avgInterval = 5;
        let timer = null;
        let recognition = null;

        // 1. ìŒì„± ì¸ì‹ ì—”ì§„ ì´ˆê¸°í™” (ëŠê¹€ ë°©ì§€ ì„¤ì •)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;      // í•µì‹¬: ì§€ì†ì  ì¸ì‹
            recognition.interimResults = false; // ì¤‘ê°„ ê²°ê³¼ ë¬´ì‹œ (ì•ˆì •ì„±)
            recognition.lang = 'ko-KR';

            recognition.onresult = (event) => {
                const cmd = event.results[event.results.length - 1].transcript.trim();
                if (cmd.includes("ì‹œì‘")) { if (!isRunning) toggleTraining(true); }
                else if (cmd.includes("ì •ì§€") || cmd.includes("ë©ˆì¶°")) { if (isRunning) toggleTraining(false); }
                else if (cmd.includes("ì´ˆ")) {
                    const num = parseInt(cmd.replace(/[^0-9]/g, ""));
                    if (num >= 3) { avgInterval = num; updateUI(); speak(`${avgInterval}ì´ˆ ì„¤ì •`); }
                }
            };

            recognition.onstart = () => { 
                micStatus.textContent = "ğŸŸ¢ ìŒì„±ì¸ì‹ ì¤‘"; 
                micStatus.style.color = "#44bd32"; 
            };

            // ëŠê¹€ ë°©ì§€ í•µì‹¬: ì¸ì‹ì´ ì¢…ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ì¦‰ì‹œ ì¬ì‹œì‘
            recognition.onend = () => {
                if (recognition) {
                    console.log("ì¸ì‹ ì¬ì‹œì‘...");
                    try { recognition.start(); } catch(e) {}
                }
            };

            recognition.onerror = (e) => {
                console.error("ì—ëŸ¬ ë°œìƒ:", e.error);
                if (e.error === 'network') speak("ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
            };
        }

        function updateUI() {
            currentValDisplay.textContent = avgInterval;
            rangeValDisplay.textContent = `${avgInterval - 2}~${avgInterval + 2}`;
        }

        function runTraining() {
            if (!isRunning) return;
            const visual = directions[Math.floor(Math.random() * directions.length)];
            const audio = directions[Math.floor(Math.random() * directions.length)];
            directionDisplay.textContent = visual.arrow;
            document.body.style.backgroundColor = visual.color;
            if ("vibrate" in navigator) navigator.vibrate(100);
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(audio.label);
            u.lang = 'ko-KR'; u.rate = 1.4;
            window.speechSynthesis.speak(u);
            const nextTime = Math.floor(Math.random() * 4001) + (avgInterval - 2) * 1000;
            timer = setTimeout(runTraining, Math.max(1000, nextTime));
        }

        const directions = [
            { arrow: 'â†‘', label: 'ìœ„ë¡œ', color: '#2ecc71' },
            { arrow: 'â†“', label: 'ì•„ë˜ë¡œ', color: '#e74c3c' },
            { arrow: 'â†', label: 'ì™¼ìª½', color: '#3498db' },
            { arrow: 'â†’', label: 'ì˜¤ë¥¸ìª½', color: '#9b59b6' }
        ];

        async function toggleTraining(start) {
            if (start) {
                isRunning = true;
                if ('wakeLock' in navigator) try { await navigator.wakeLock.request('screen'); } catch(e){}
                runTraining();
            } else {
                isRunning = false;
                clearTimeout(timer);
                window.speechSynthesis.cancel();
                directionDisplay.textContent = 'READY';
                document.body.style.backgroundColor = '#222';
            }
        }

        function speak(t) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'ko-KR'; window.speechSynthesis.speak(u);
        }

        // Brave í„°ì¹˜ ì¸ì‹ ê°œì„ 
        window.addEventListener('touchstart', (e) => {
            if (recognition) {
                try {
                    recognition.start();
                    speak("ìŒì„± ì œì–´ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");
                } catch(err) {
                    console.log("ì´ë¯¸ ì‹¤í–‰ ì¤‘");
                }
            }
        }, { once: true });
    </script>
</body>
</html>
