<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë°˜ì‘ í›ˆë ¨ Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#222222">
    <style>
        :root { --bg-color: #222; }
        body {
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            height: 100vh; width: 100vw;
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color); color: white;
            transition: background-color 0.15s ease-out; 
            touch-action: none; overflow: hidden;
        }

        /* ì •ë³´ì°½: ì„¸ë¡œ ëª¨ë“œì—ì„œ ìƒë‹¨ì— ì•ˆì •ì ìœ¼ë¡œ ë°°ì¹˜ */
        #info { 
            position: absolute; top: env(safe-area-inset-top, 20px); 
            text-align: center; z-index: 10; width: 85%;
            font-size: clamp(0.85rem, 4vw, 1.1rem);
            background: rgba(0,0,0,0.5); padding: 12px; border-radius: 16px;
            backdrop-filter: blur(10px); line-height: 1.5;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        #mic-status { color: #ff4757; font-weight: bold; margin-bottom: 4px; display: block; }
        
        /* ë©”ì¸ ë°©í–¥ í…ìŠ¤íŠ¸: ì˜ë¦¼ ë°©ì§€ ìµœì í™” */
        #direction-container {
            display: flex; align-items: center; justify-content: center;
            width: 100%; height: 60%; /* ì •ë³´ì°½ ì˜ì—­ ì œì™¸í•˜ê³  ì¤‘ì•™ ë°°ì¹˜ */
        }
        #direction-text { 
            /* í™”ë©´ ë„ˆë¹„(vw)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë˜ ì„¸ë¡œ ë†’ì´(vh)ë¥¼ ì´ˆê³¼í•˜ì§€ ì•Šê²Œ ì œí•œ */
            font-size: clamp(5rem, 50vw, 35vh); 
            font-weight: 900; user-select: none;
            line-height: 1; margin: 0; padding: 0;
            text-align: center;
            word-break: keep-all;
        }
        
        .val { color: #fbc531; font-weight: bold; }

        /* ê°€ë¡œ ëª¨ë“œ (Landscape) ëŒ€ì‘ ìµœì í™” */
        @media (orientation: landscape) {
            #info { 
                top: auto; bottom: 5%; left: 50%; transform: translateX(-50%);
                width: auto; padding: 8px 30px; display: flex; gap: 15px; align-items: center;
            }
            #mic-status { margin-bottom: 0; margin-right: 10px; }
            #direction-text { font-size: 45vh; }
            #direction-container { height: 100%; }
        }
    </style>
</head>
<body>

    <div id="info">
        <span id="mic-status">ğŸ”´ í„°ì¹˜í•˜ì—¬ ì‹œì‘</span>
        <div>ë§ì”€í•˜ì„¸ìš”: <span class="val">"ì‹œì‘"</span>, <span class="val">"ì •ì§€"</span>, <span class="val">"5ì´ˆ"</span></div>
        <div>ì„¤ì •: <span id="current-val" class="val">5</span>ì´ˆ (<span id="range-val" class="val">3~7</span>ì´ˆ)</div>
    </div>

    <div id="direction-container">
        <div id="direction-text">READY</div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(e => {});
        }

        const directionDisplay = document.getElementById('direction-text');
        const currentValDisplay = document.getElementById('current-val');
        const rangeValDisplay = document.getElementById('range-val');
        const micStatus = document.getElementById('mic-status');
        
        let isRunning = false;
        let timer = null;
        let avgInterval = 5;
        let wakeLock = null;

        const directions = [
            { arrow: 'â†‘', label: 'ìœ„ë¡œ', color: '#2ecc71' },
            { arrow: 'â†“', label: 'ì•„ë˜ë¡œ', color: '#e74c3c' },
            { arrow: 'â†', label: 'ì™¼ìª½', color: '#3498db' },
            { arrow: 'â†’', label: 'ì˜¤ë¥¸ìª½', color: '#9b59b6' }
        ];

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const cmd = event.results[event.results.length - 1].transcript.trim();
                if (cmd.includes("ì‹œì‘")) { if (!isRunning) toggleTraining(true); }
                else if (cmd.includes("ì •ì§€") || cmd.includes("ë©ˆì¶°")) { if (isRunning) toggleTraining(false); }
                else if (cmd.includes("ì´ˆ")) {
                    const num = parseInt(cmd.replace(/[^0-9]/g, ""));
                    if (num >= 3) { avgInterval = num; updateUI(); speak(`${avgInterval}ì´ˆ ì„¤ì •`); }
                }
            };

            recognition.onstart = () => { 
                micStatus.textContent = "ğŸŸ¢ ìŒì„±ì¸ì‹ í™œì„±í™”"; 
                micStatus.style.color = "#44bd32"; 
            };
            recognition.onend = () => { if(isRunning) recognition.start(); };
        }

        function updateUI() {
            currentValDisplay.textContent = avgInterval;
            rangeValDisplay.textContent = `${avgInterval - 2}~${avgInterval + 2}`;
        }

        function runTraining() {
            if (!isRunning) return;
            const visual = directions[Math.floor(Math.random() * directions.length)];
            const audio = directions[Math.floor(Math.random() * directions.length)];
            
            directionDisplay.textContent = visual.arrow;
            document.body.style.backgroundColor = visual.color;

            if ("vibrate" in navigator) navigator.vibrate(100);
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(audio.label);
            utterance.lang = 'ko-KR';
            utterance.rate = 1.4;
            window.speechSynthesis.speak(utterance);

            const nextTime = Math.floor(Math.random() * 4001) + (avgInterval - 2) * 1000;
            timer = setTimeout(runTraining, Math.max(1000, nextTime));
        }

        async function toggleTraining(start) {
            if (start) {
                isRunning = true;
                if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }
                runTraining();
            } else {
                isRunning = false;
                clearTimeout(timer);
                window.speechSynthesis.cancel();
                if (wakeLock) { try { wakeLock.release(); } catch(e){} wakeLock = null; }
                directionDisplay.textContent = 'READY';
                document.body.style.backgroundColor = '#222';
            }
        }

        function speak(text) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ko-KR';
            window.speechSynthesis.speak(u);
        }

        window.addEventListener('touchstart', () => {
            if (recognition) {
                try { recognition.start(); speak("ë°˜ì‘ í›ˆë ¨ ì¤€ë¹„ ì™„ë£Œ"); } catch(e) {}
            }
        }, { once: true });
    </script>
</body>
</html>
